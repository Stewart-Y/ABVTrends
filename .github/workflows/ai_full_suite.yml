name: Full AI QA Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 */6 * * *"  # Run every 6 hours
  workflow_dispatch:
    inputs:
      run_exploratory:
        description: 'Run exploratory testing'
        required: false
        default: 'false'
        type: boolean
      run_stress:
        description: 'Run stress testing'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ==================== E2E Tests ====================
  e2e-tests:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: abvtrends
          POSTGRES_PASSWORD: abvtrends
          POSTGRES_DB: abvtrends_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          pip install anthropic playwright bandit locust

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Install backend dependencies
        working-directory: backend
        run: |
          pip install -r requirements.txt

      - name: Start backend server
        working-directory: backend
        env:
          DATABASE_URL: postgresql://abvtrends:abvtrends@localhost:5432/abvtrends_test
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 10

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Run Playwright tests
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000
        run: npm run test:e2e
        continue-on-error: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/tests/playwright/reports/
          retention-days: 14

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results
          path: frontend/tests/ai/results/playwright-results.json
          retention-days: 14

  # ==================== AI Self-Healing ====================
  ai-self-healing:
    name: Claude Self-Healing Analysis
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: always()
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install anthropic

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: playwright-results
          path: frontend/tests/ai/results/
        continue-on-error: true

      - name: Run Claude self-healing analysis
        working-directory: frontend/tests/ai
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python run_claude_tests.py --skip-run
        continue-on-error: true

      - name: Upload AI analysis
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-analysis
          path: frontend/tests/ai/suggestions/
          retention-days: 14

  # ==================== Coverage Analysis ====================
  coverage-analysis:
    name: AI Coverage Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install anthropic

      - name: Run coverage analysis
        working-directory: frontend/tests/ai
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python coverage/coverage_mapper.py
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: frontend/tests/ai/results/coverage_report*.md
          retention-days: 14

  # ==================== Security Scan ====================
  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install anthropic bandit

      - name: Run security analysis
        working-directory: frontend/tests/ai
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python security/security_analyzer.py
        continue-on-error: true

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: |
            frontend/tests/ai/results/security_report*.md
            frontend/tests/ai/results/security_raw.json
          retention-days: 14

  # ==================== Exploratory Testing ====================
  exploratory-testing:
    name: AI Exploratory Testing
    runs-on: ubuntu-latest
    if: github.event.inputs.run_exploratory == 'true' || github.event_name == 'schedule'
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: abvtrends
          POSTGRES_PASSWORD: abvtrends
          POSTGRES_DB: abvtrends_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install anthropic playwright
          npx playwright install chromium

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install backend dependencies
        working-directory: backend
        run: pip install -r requirements.txt

      - name: Start servers
        env:
          DATABASE_URL: postgresql://abvtrends:abvtrends@localhost:5432/abvtrends_test
        run: |
          cd backend && uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          cd frontend && npm run build && npm start &
          sleep 20

      - name: Run exploratory testing
        working-directory: frontend/tests/ai
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BASE_URL: http://localhost:3000
        run: python explore/exploratory_agent.py
        continue-on-error: true

      - name: Upload exploration report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: exploration-report
          path: frontend/tests/ai/results/exploration*.md
          retention-days: 14

  # ==================== Stress Testing ====================
  stress-testing:
    name: Load/Stress Testing
    runs-on: ubuntu-latest
    if: github.event.inputs.run_stress == 'true'
    timeout-minutes: 45

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: abvtrends
          POSTGRES_PASSWORD: abvtrends
          POSTGRES_DB: abvtrends_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install locust anthropic

      - name: Install backend dependencies
        working-directory: backend
        run: pip install -r requirements.txt

      - name: Start backend server
        working-directory: backend
        env:
          DATABASE_URL: postgresql://abvtrends:abvtrends@localhost:5432/abvtrends_test
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4 &
          sleep 10

      - name: Run load test
        working-directory: frontend/tests/ai/stress
        run: |
          locust -f locustfile.py \
            --host=http://localhost:8000 \
            --headless \
            -u 100 -r 10 -t 5m \
            --csv=../results/loadtest
        continue-on-error: true

      - name: Upload load test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: loadtest-results
          path: frontend/tests/ai/results/loadtest*.csv
          retention-days: 14

  # ==================== Summary Report ====================
  summary:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: [e2e-tests, ai-self-healing, coverage-analysis, security-scan]
    if: always()
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Generate summary
        run: |
          echo "# AI QA Suite Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AI Self-Healing | ${{ needs.ai-self-healing.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage Analysis | ${{ needs.coverage-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "All reports are available in the Actions artifacts section." >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              'e2e-tests': '${{ needs.e2e-tests.result }}',
              'ai-self-healing': '${{ needs.ai-self-healing.result }}',
              'coverage-analysis': '${{ needs.coverage-analysis.result }}',
              'security-scan': '${{ needs.security-scan.result }}'
            };

            const statusEmoji = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              if (status === 'skipped') return 'â­ï¸';
              return 'âš ï¸';
            };

            let comment = '## ğŸ¤– AI QA Suite Results\n\n';
            comment += '| Test Suite | Status |\n';
            comment += '|-----------|--------|\n';
            for (const [job, status] of Object.entries(results)) {
              comment += `| ${job} | ${statusEmoji(status)} ${status} |\n`;
            }
            comment += '\nğŸ“Š Full reports available in [Actions artifacts](';
            comment += `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload combined report
        uses: actions/upload-artifact@v4
        with:
          name: full-qa-report
          path: artifacts/
          retention-days: 30
